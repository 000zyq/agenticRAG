# 2026-02-12 Project Log

## Context
- User requested: prioritize TODO execution and keep daily discoveries/issues in `agent_logs`.
- Current risk: `merge_cas2020_toc_dictionary.py --create-missing` introduced many `cas2020_*` metrics into core dictionary.

## Findings
- `data/financial_dictionary.json` currently contains `134` entries with `metric_code` prefix `cas2020_`.
- `contract_assets` is now present in dictionary (from explicit override), but long-tail `cas2020_*` metrics may reduce dictionary precision and maintainability.

## Plan
1. Prune `cas2020_*` auto-created metrics from core dictionary.
2. Re-run CAS2020 merge in non-creating mode (alias enrichment only).
3. Sync dictionary to DB and run eval to confirm no regression.

## Execution
- Added `scripts/prune_cas2020_generated_metrics.py`.
- Pruned dictionary:
  - before: 240
  - after: 106
  - removed: 134 (`cas2020_*`)
- Ran `merge_cas2020_toc_dictionary.py` in non-creating mode and found a bug:
  - repeated labels on one metric caused false ambiguity in index and near-zero matches.
- Fixed index de-dup bug in `scripts/merge_cas2020_toc_dictionary.py`.
- Re-ran merge result:
  - matched: 39
  - created: 0
  - alias_added: 107
  - skipped: 97
- Synced dictionary to DB: 106 metrics.

## Validation
- `scripts/eval_pdf2db.py` (MinerU env enabled):
  - `core_metric_match_rate`: 0.3604
  - `statement_table_rate`: 0.7596
  - `table_unit_rate`: 0.9135
  - `table_currency_rate`: 0.9038
  - No errors.

## Open Issues
- CAS2020 TOC has many long-tail sub-categories not mapped to core metrics (currently skipped by design).
- Background rules are extracted but not yet wired into parser routing/validation.

## 2026-02-12 Follow-up (P0-2 + write quality)

### Changes
- Added CAS2020 mapping artifact output and generated:
  - `data/taxonomy/cas2020_metric_mapping.json`
- Integrated mapping fallback into runtime metric matcher:
  - `app/ingest/metric_defs.py`
  - `match_metric()` now tries CAS2020 mapping before returning `None`.
- Added unit tests:
  - `tests/test_metric_defs_mapping.py` (3 cases)
- Tightened ingestion write gate:
  - `scripts/ingest_financial_report.py`
  - default `INGEST_CORE_STATEMENTS_ONLY=true`
  - only core statement tables are written by default
  - `MIN_METRIC_ROWS_PER_TABLE` threshold (default `2`)
- Tightened matcher precision:
  - removed broad pattern-substring matching
  - switched to exact/controlled prefix-suffix matching to avoid detail-row overmatch.

### Validation
- Lint:
  - `ruff check` passed
- Tests:
  - `pytest -m "not integration"` passed (`11 passed, 1 deselected`)
- Recompute run:
  - `.venv/bin/python scripts/ingest_financial_report.py --recompute-facts`
  - report_id: `2`

### DB quality comparison (report_id=2)
- After only CAS mapping integration (before table gate tightening):
  - `flow_candidates`: 503
  - `stock_candidates`: 628
  - `flow_raw_candidates`: 232
  - `stock_raw_candidates`: 406
- After table gate + matcher tightening:
  - `flow_candidates`: 137
  - `stock_candidates`: 136
  - `flow_raw_candidates`: 26
  - `stock_raw_candidates`: 8
  - `flow_raw_metric_codes`: 10
  - `stock_raw_metric_codes`: 3
  - groups with `count(distinct value) > 2`:
    - stock: `0`
    - flow: `0`

### Tradeoff
- Parser-only metric coverage dropped in quick eval:
  - `core_metric_match_rate`: `0.2189`
- Interpretation:
  - precision improved for write path (less noisy metrics, fewer conflicting values)
  - recall in parser-only matching needs calibration with labeled set (new P0 item).

## 2026-02-12 Follow-up (P0-3 background rules integration)

### Changes
- Integrated CAS2020 background rules into parser:
  - `app/ingest/financial_report.py`
  - load `data/taxonomy/cas2020_background_rules.json` at startup
  - build `ELR_STATEMENT_MAP` from `elr_changes` and route `statement_type` by ELR code in `_detect_statement_type`
  - build `KNOWN_ELEMENT_TYPES` from `element_types` and validate MinerU `content_list` item types before parsing.
- Added tests:
  - `tests/test_parsing_utils.py::test_detect_statement_type_from_elr_code`
  - `tests/test_parsing_utils.py::test_mineru_content_list_unknown_type_filtered`

### Validation
- `ruff check` passed.
- `pytest -m "not integration"` passed (`13 passed, 1 deselected`).
- quick eval rerun:
  - `doc_success_rate`: `1.0`
  - `core_metric_match_rate`: `0.2189` (unchanged from previous strict-match baseline)
  - no parser errors.

### Note
- This step improves routing robustness for ELR-coded headings and parser input hygiene.
- Next priority remains recall calibration with a labeled set because current write-path precision optimizations reduced parser-only match recall.

## 2026-02-12 Follow-up (P0-4 match calibration)

### Changes
- Added labeled metric-match dataset:
  - `tests/fixtures/metric_match_cases.json`
  - includes `required` cases for regression gating and `optional` stretch cases.
- Added metric-match evaluator:
  - `scripts/eval_metric_match_cases.py`
  - outputs exact-match/precision/recall/f1 and error cases.
- Added regression test:
  - `tests/test_metric_match_cases.py`
  - current gates: `exact_rate >= 0.90`, `negative false positive rate <= 0.10`.
- Wired eval workflow:
  - `Makefile` adds `eval-metric-match`
  - `eval-regression` now runs `eval-fast` + `eval-metric-match`.
- Matcher calibration updates:
  - `normalize_label` now strips `、`
  - added safe exact alias: `资产合计 -> total_assets`
  - kept strict no-substring policy while allowing controlled prefix/suffix matches.

### Validation
- `ruff check` passed.
- `pytest -m "not integration"` passed (`14 passed, 1 deselected`).
- `make eval-metric-match`:
  - `required exact_match_rate`: `1.0000`
  - `all_cases exact_match_rate`: `1.0000`
  - `false_positive_rate_on_negatives`: `0.0`
- `make eval-fast`:
  - `core_metric_match_rate`: `0.2189 -> 0.2568`
  - no parser errors.

### DB impact (report_id=2, recompute-facts)
- before this calibration pass:
  - `flow_candidates=137`, `stock_candidates=136`, `flow_raw=26`, `stock_raw=8`
- after this calibration pass (`version_id=35`):
  - `flow_candidates=161`, `stock_candidates=136`, `flow_raw=14`, `stock_raw=8`
  - high-variance collision groups (`count(distinct value) > 2`): `flow=0`, `stock=0`

### Conclusion
- Recall improved while write-path noise did not regress; flow-side raw labels reduced further.

## 2026-02-12 Follow-up (P1-4 MinerU cache hardening)

### Changes
- Hardened MinerU subprocess environment to fixed `/tmp` cache paths:
  - `XDG_CACHE_HOME=/tmp`
  - `HF_HOME=/tmp`
  - `HUGGINGFACE_HUB_CACHE=/tmp`
  - `TRANSFORMERS_CACHE=/tmp`
  - `MPLCONFIGDIR=/tmp/mplconfig`
- Added helper:
  - `app/ingest/financial_report.py::_build_mineru_env()`
- Added test:
  - `tests/test_parsing_utils.py::test_build_mineru_env_uses_tmp_cache`

### Validation
- `pytest -m "not integration"` passed (`15 passed, 1 deselected`).
- `make eval-regression` passed.
- `eval-fast`:
  - `core_metric_match_rate`: `0.2568`
  - no parser errors.
- `eval-metric-match`:
  - required/all exact match: `1.0`

## 2026-02-12 Follow-up (P1-5/6/7/8 completion)

### Changes
- P1-5: strengthened MinerU output traceability in version summary:
  - `scripts/ingest_financial_report.py`
  - added `_mineru_output_summary(parse_method, source_path)`
  - summary now includes:
    - `mineru_output_dir`
    - `mineru_output_report_dir`
    - `mineru_content_list_path` (if available)
  - applied to all report version branches (fresh ingest, append candidates, recompute, duplicate skip).
- P1-6: added parser regression test proving HTML table path is preferred:
  - `tests/test_table_detection.py::test_detect_table_blocks_prefers_mineru_html_table`
- P1-7: tightened CAS2020 merge alias writes:
  - `scripts/merge_cas2020_toc_dictionary.py`
  - introduced stop-label and short-label deny filters when appending Chinese aliases.
- P1-8: enforced runtime short-label policy at dictionary load:
  - `app/ingest/metric_defs.py`
  - short labels are moved to exact bucket; generic short Chinese labels are dropped.

### New tests
- `tests/test_ingest_financial_report_script.py` (MinerU output summary behavior)
- `tests/test_dictionary_merge_guards.py` (short/generic merge guards)

### Validation
- `ruff check` passed.
- `pytest -m "not integration"` passed (`22 passed, 1 deselected`).
- `make eval-regression` passed.
- metrics remain stable:
  - `core_metric_match_rate`: `0.2568`
  - `metric_match required/all exact`: `1.0`

### Note
- One attempt to run a live ingest for DB-side summary validation was interrupted by user (approval dialog aborted). Code-level coverage and unit tests for summary fields are complete.
