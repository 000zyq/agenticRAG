# 2026-02-12 Project Log

## Context
- User requested: prioritize TODO execution and keep daily discoveries/issues in `agent_logs`.
- Current risk: `merge_cas2020_toc_dictionary.py --create-missing` introduced many `cas2020_*` metrics into core dictionary.

## Findings
- `data/financial_dictionary.json` currently contains `134` entries with `metric_code` prefix `cas2020_`.
- `contract_assets` is now present in dictionary (from explicit override), but long-tail `cas2020_*` metrics may reduce dictionary precision and maintainability.

## Plan
1. Prune `cas2020_*` auto-created metrics from core dictionary.
2. Re-run CAS2020 merge in non-creating mode (alias enrichment only).
3. Sync dictionary to DB and run eval to confirm no regression.

## Execution
- Added `scripts/prune_cas2020_generated_metrics.py`.
- Pruned dictionary:
  - before: 240
  - after: 106
  - removed: 134 (`cas2020_*`)
- Ran `merge_cas2020_toc_dictionary.py` in non-creating mode and found a bug:
  - repeated labels on one metric caused false ambiguity in index and near-zero matches.
- Fixed index de-dup bug in `scripts/merge_cas2020_toc_dictionary.py`.
- Re-ran merge result:
  - matched: 39
  - created: 0
  - alias_added: 107
  - skipped: 97
- Synced dictionary to DB: 106 metrics.

## Validation
- `scripts/eval_pdf2db.py` (MinerU env enabled):
  - `core_metric_match_rate`: 0.3604
  - `statement_table_rate`: 0.7596
  - `table_unit_rate`: 0.9135
  - `table_currency_rate`: 0.9038
  - No errors.

## Open Issues
- CAS2020 TOC has many long-tail sub-categories not mapped to core metrics (currently skipped by design).
- Background rules are extracted but not yet wired into parser routing/validation.

## 2026-02-12 Follow-up (P0-2 + write quality)

### Changes
- Added CAS2020 mapping artifact output and generated:
  - `data/taxonomy/cas2020_metric_mapping.json`
- Integrated mapping fallback into runtime metric matcher:
  - `app/ingest/metric_defs.py`
  - `match_metric()` now tries CAS2020 mapping before returning `None`.
- Added unit tests:
  - `tests/test_metric_defs_mapping.py` (3 cases)
- Tightened ingestion write gate:
  - `scripts/ingest_financial_report.py`
  - default `INGEST_CORE_STATEMENTS_ONLY=true`
  - only core statement tables are written by default
  - `MIN_METRIC_ROWS_PER_TABLE` threshold (default `2`)
- Tightened matcher precision:
  - removed broad pattern-substring matching
  - switched to exact/controlled prefix-suffix matching to avoid detail-row overmatch.

### Validation
- Lint:
  - `ruff check` passed
- Tests:
  - `pytest -m "not integration"` passed (`11 passed, 1 deselected`)
- Recompute run:
  - `.venv/bin/python scripts/ingest_financial_report.py --recompute-facts`
  - report_id: `2`

### DB quality comparison (report_id=2)
- After only CAS mapping integration (before table gate tightening):
  - `flow_candidates`: 503
  - `stock_candidates`: 628
  - `flow_raw_candidates`: 232
  - `stock_raw_candidates`: 406
- After table gate + matcher tightening:
  - `flow_candidates`: 137
  - `stock_candidates`: 136
  - `flow_raw_candidates`: 26
  - `stock_raw_candidates`: 8
  - `flow_raw_metric_codes`: 10
  - `stock_raw_metric_codes`: 3
  - groups with `count(distinct value) > 2`:
    - stock: `0`
    - flow: `0`

### Tradeoff
- Parser-only metric coverage dropped in quick eval:
  - `core_metric_match_rate`: `0.2189`
- Interpretation:
  - precision improved for write path (less noisy metrics, fewer conflicting values)
  - recall in parser-only matching needs calibration with labeled set (new P0 item).

## 2026-02-12 Follow-up (P0-3 background rules integration)

### Changes
- Integrated CAS2020 background rules into parser:
  - `app/ingest/financial_report.py`
  - load `data/taxonomy/cas2020_background_rules.json` at startup
  - build `ELR_STATEMENT_MAP` from `elr_changes` and route `statement_type` by ELR code in `_detect_statement_type`
  - build `KNOWN_ELEMENT_TYPES` from `element_types` and validate MinerU `content_list` item types before parsing.
- Added tests:
  - `tests/test_parsing_utils.py::test_detect_statement_type_from_elr_code`
  - `tests/test_parsing_utils.py::test_mineru_content_list_unknown_type_filtered`

### Validation
- `ruff check` passed.
- `pytest -m "not integration"` passed (`13 passed, 1 deselected`).
- quick eval rerun:
  - `doc_success_rate`: `1.0`
  - `core_metric_match_rate`: `0.2189` (unchanged from previous strict-match baseline)
  - no parser errors.

### Note
- This step improves routing robustness for ELR-coded headings and parser input hygiene.
- Next priority remains recall calibration with a labeled set because current write-path precision optimizations reduced parser-only match recall.

## 2026-02-12 Follow-up (P0-4 match calibration)

### Changes
- Added labeled metric-match dataset:
  - `tests/fixtures/metric_match_cases.json`
  - includes `required` cases for regression gating and `optional` stretch cases.
- Added metric-match evaluator:
  - `scripts/eval_metric_match_cases.py`
  - outputs exact-match/precision/recall/f1 and error cases.
- Added regression test:
  - `tests/test_metric_match_cases.py`
  - current gates: `exact_rate >= 0.90`, `negative false positive rate <= 0.10`.
- Wired eval workflow:
  - `Makefile` adds `eval-metric-match`
  - `eval-regression` now runs `eval-fast` + `eval-metric-match`.
- Matcher calibration updates:
  - `normalize_label` now strips `、`
  - added safe exact alias: `资产合计 -> total_assets`
  - kept strict no-substring policy while allowing controlled prefix/suffix matches.

### Validation
- `ruff check` passed.
- `pytest -m "not integration"` passed (`14 passed, 1 deselected`).
- `make eval-metric-match`:
  - `required exact_match_rate`: `1.0000`
  - `all_cases exact_match_rate`: `1.0000`
  - `false_positive_rate_on_negatives`: `0.0`
- `make eval-fast`:
  - `core_metric_match_rate`: `0.2189 -> 0.2568`
  - no parser errors.

### DB impact (report_id=2, recompute-facts)
- before this calibration pass:
  - `flow_candidates=137`, `stock_candidates=136`, `flow_raw=26`, `stock_raw=8`
- after this calibration pass (`version_id=35`):
  - `flow_candidates=161`, `stock_candidates=136`, `flow_raw=14`, `stock_raw=8`
  - high-variance collision groups (`count(distinct value) > 2`): `flow=0`, `stock=0`

### Conclusion
- Recall improved while write-path noise did not regress; flow-side raw labels reduced further.

## 2026-02-12 Follow-up (P1-4 MinerU cache hardening)

### Changes
- Hardened MinerU subprocess environment to fixed `/tmp` cache paths:
  - `XDG_CACHE_HOME=/tmp`
  - `HF_HOME=/tmp`
  - `HUGGINGFACE_HUB_CACHE=/tmp`
  - `TRANSFORMERS_CACHE=/tmp`
  - `MPLCONFIGDIR=/tmp/mplconfig`
- Added helper:
  - `app/ingest/financial_report.py::_build_mineru_env()`
- Added test:
  - `tests/test_parsing_utils.py::test_build_mineru_env_uses_tmp_cache`

### Validation
- `pytest -m "not integration"` passed (`15 passed, 1 deselected`).
- `make eval-regression` passed.
- `eval-fast`:
  - `core_metric_match_rate`: `0.2568`
  - no parser errors.
- `eval-metric-match`:
  - required/all exact match: `1.0`

## 2026-02-12 Follow-up (P1-5/6/7/8 completion)

### Changes
- P1-5: strengthened MinerU output traceability in version summary:
  - `scripts/ingest_financial_report.py`
  - added `_mineru_output_summary(parse_method, source_path)`
  - summary now includes:
    - `mineru_output_dir`
    - `mineru_output_report_dir`
    - `mineru_content_list_path` (if available)
  - applied to all report version branches (fresh ingest, append candidates, recompute, duplicate skip).
- P1-6: added parser regression test proving HTML table path is preferred:
  - `tests/test_table_detection.py::test_detect_table_blocks_prefers_mineru_html_table`
- P1-7: tightened CAS2020 merge alias writes:
  - `scripts/merge_cas2020_toc_dictionary.py`
  - introduced stop-label and short-label deny filters when appending Chinese aliases.
- P1-8: enforced runtime short-label policy at dictionary load:
  - `app/ingest/metric_defs.py`
  - short labels are moved to exact bucket; generic short Chinese labels are dropped.

### New tests
- `tests/test_ingest_financial_report_script.py` (MinerU output summary behavior)
- `tests/test_dictionary_merge_guards.py` (short/generic merge guards)

### Validation
- `ruff check` passed.
- `pytest -m "not integration"` passed (`22 passed, 1 deselected`).
- `make eval-regression` passed.
- metrics remain stable:
  - `core_metric_match_rate`: `0.2568`
  - `metric_match required/all exact`: `1.0`

### Note
- One attempt to run a live ingest for DB-side summary validation was interrupted by user (approval dialog aborted). Code-level coverage and unit tests for summary fields are complete.

## 2026-02-12 Follow-up (P2-1 consistency stabilization)

### Problem
- On sample report (`report_id=2`), balance checks passed but cash check failed:
  - `cash_end_eq_cash_begin_plus_increase` failed for both `consolidated` and `parent`.
- Root cause:
  - resolver tie-break in single-engine mode was effectively arbitrary across candidate values,
  - and could mix current/prior columns (`col_1` vs `col_2`) for related cash metrics.

### Changes
- Updated resolver candidate ranking to be column-aware:
  - file: `scripts/resolve_fact_candidates.py`
  - added `column_label` on candidate loaders (via `source_trace` join)
  - added `_column_score()` preference:
    - prefer `col_1`
    - prefer `current/本期/本年`
    - prefer later year labels (`2024` > `2023`)
  - integrated into group ranking and final candidate tie-break.
- Made DB dependency lazy-import in resolver script for CI-safe utility imports.
- Added regression tests:
  - `tests/test_resolve_candidate_priority.py`

### Validation
- `ruff check` passed.
- `pytest -m "not integration"` passed (`24 passed, 1 deselected`).
- Recomputed + resolved sample report:
  - command:
    - `.venv/bin/python scripts/ingest_financial_report.py --recompute-facts`
    - `.venv/bin/python scripts/resolve_fact_candidates.py --report-id 2 --min-agree 1`
  - consistency checks:
    - `assets_eq_liab_equity_total`: pass (consolidated, parent)
    - `cash_end_eq_cash_begin_plus_increase`: pass (consolidated, parent)

## 2026-02-12 Follow-up (P2-2 multi-engine coverage + MinerU false-negative fix)

### Problem
- Multi-engine command logs showed MinerU full pipeline completion and output files, but ingestion still marked engine failure:
  - warning: `engine mineru failed: MinerU extraction failed or MINERU_CMD not set.`
- DB evidence confirmed only `pypdf` candidate version existed (`report_id=2`), causing:
  - `multi_engine_groups_with_multi = 0`.

### Root cause
- `app/ingest/financial_report.py::_mineru_extract()` returned `None` immediately on `subprocess.CalledProcessError`.
- MinerU can produce valid artifacts (`*_content_list.json`, `.md`) even when CLI exit code is non-zero.

### Changes
- Updated `_mineru_extract()`:
  - on `CalledProcessError`, no longer early-returns `None`.
  - continues to parse existing MinerU artifacts from output dir.
- Added tests:
  - `tests/test_mineru_extract.py::test_mineru_extract_uses_artifacts_even_if_cli_returns_nonzero`
  - `tests/test_mineru_extract.py::test_mineru_extract_returns_none_when_no_artifacts`

### Validation
- unit checks:
  - `ruff check app/ingest/financial_report.py tests/test_mineru_extract.py` passed
  - `pytest tests/test_mineru_extract.py -q` passed
  - `pytest -m "not integration"` passed (`28 passed, 1 deselected`)
- functional check without rerunning heavy MinerU:
  - set `MINERU_CMD=false` with `MINERU_OUTPUT_DIR=tmp/mineru_output`
  - `extract_pdf_to_markdown(..., engine="mineru")` returns pages (`217`), proving artifact fallback works.
- end-to-end multi-engine ingest (using cached output artifacts):
  - `multi_engine_groups_with_multi`: `135`
  - `multi_engine_agreement_rate`: `1.0`
  - consistency:
    - `assets_eq_liab_equity_total`: pass (both scopes)
    - `cash_end_eq_cash_begin_plus_increase`: pass (both scopes)
    - `net_increase_eq_sum_cashflows`: fail (both scopes, tracked as next task)

### Coverage-gap breakdown
- latest versions for `report_id=2`:
  - `pypdf`: `version_id=49`
  - `mineru`: `version_id=50`
- group counts by engine:
  - flow groups: `pypdf=99`, `mineru=154`, overlap=`67`
  - stock groups: `pypdf=72`, `mineru=100`, overlap=`68`
  - single-engine groups total: `155` = `mineru-only 119` + `pypdf-only 36`
- interpretation:
  - main gap is `pypdf` recall shortfall versus MinerU on this document.
  - some residual fragmentation remains from `raw_*` metrics and metadata key split (`unit/currency/scope`).

## 2026-02-12 Follow-up (unit pollution + year-label parsing)

### Problem
- `pypdf-only` gap rows contained malformed `unit` values (long text copied from headers).
- HTML table headers like `2024年度/2023年度` were not parsed into `fiscal_year`, which can blur period alignment.

### Changes
- `app/ingest/financial_report.py`
  - removed unsafe fallback in `_detect_units()` that set `units = text.strip()` whenever `"单位"` appeared.
  - added constrained `UNIT_HINT_RE` parsing for explicit `单位: ...` hints only.
  - added `_extract_fiscal_year()` and used it in HTML column parsing.
  - for HTML headers, `period_end` now derives from parsed year (`YYYY-12-31`) when label carries a year token.
- tests:
  - `tests/test_parsing_utils.py::test_detect_units_does_not_fallback_to_long_text`
  - `tests/test_table_detection.py::test_detect_table_blocks_parses_year_labels_from_html_header`

### Validation
- quality checks:
  - `ruff check` passed
  - `pytest -m "not integration"` passed (`30 passed, 1 deselected`)
- end-to-end rerun (cached MinerU artifacts):
  - command used `MINERU_CMD=false` + `MINERU_OUTPUT_DIR=tmp/mineru_output` for fast verification
  - latest versions: `pypdf=52`, `mineru=53`, `consensus=54`
  - unit sanity:
    - `pypdf flow/stock bad_unit_rows = 0`
    - `mineru flow/stock bad_unit_rows = 0`
  - agreement summary:
    - `multi_engine_groups_with_multi = 158`
    - `multi_engine_agreement_rate = 1.0`

## 2026-02-12 Follow-up (merged-cell HTML parsing phase-1)

### Problem
- MinerU HTML table path previously ignored `rowspan/colspan`, which could shift header/value alignment.
- Multi-row headers (e.g. `2024年度/2023年度` + `本期/上期`) were not merged into stable column labels.

### Changes
- `app/ingest/financial_report.py`
  - added HTML span parsing for `<td>/<th>`:
    - `_html_cell_spans()`
    - `_expand_html_rows()` for logical-grid expansion with carried row spans
    - `_merge_header_rows()` for multi-header composition
  - updated `_parse_html_tables()` to use expanded rows and merged headers.
  - retained existing quality gates (`rows_with_numbers`, statement/type filters).
- tests:
  - `tests/test_table_detection.py::test_detect_table_blocks_handles_rowspan_colspan_header`
  - verifies merged header to four columns with fiscal years (`2024`, `2023`) and correct row labels.

### Validation
- static + unit:
  - `ruff check app/ingest/financial_report.py tests/test_table_detection.py` passed
  - `pytest tests/test_table_detection.py -q` passed (`4 passed`)
  - `pytest -m "not integration"` passed (`31 passed, 1 deselected`)
- end-to-end fast ingest (cached MinerU artifacts, no model rerun):
  - `report_id=2`, consensus summary still generated successfully
  - `multi_engine_groups_with_multi = 158`
  - `multi_engine_agreement_rate = 1.0`

## 2026-02-12 Follow-up (cashflow consistency P2-3 closure)

### Problem
- `net_increase_eq_sum_cashflows` was failing with small residual diffs while other checks passed.
- Root causes:
  - consistency formula did not include FX impact line (`汇率变动对现金及现金等价物的影响`)
  - metric matching for that label was blocked by over-broad ratio heuristic (`"率"` in label => ratio-only).

### Changes
- `app/ingest/metric_defs.py`
  - added metric: `fx_effect_on_cash`
  - updated metric source merge logic: dictionary file remains primary, but missing `BASE` metrics are now auto-appended.
  - tightened ratio heuristic in `match_metric()`:
    - from broad `"率" in label`
    - to ratio-like labels only (`%`, suffix `率`, contains `比率/比例`)
- `scripts/resolve_fact_candidates.py`
  - added `_cashflow_net_increase_rhs(...)`
  - cashflow consistency now computes:
    - `net_increase == operating + investing + financing (+ fx_effect_if_present)`
  - added fallback metric lookup by `metric_name_cn LIKE '%汇率变动对现金及现金等价物的影响%'` for legacy/raw code data.
  - consistency output now includes `fx_effect` field.
- tests:
  - added `tests/test_cashflow_consistency_formula.py`
  - extended metric-match fixture with FX case (`p12b`).

### Validation
- quality:
  - `ruff check` passed
  - `pytest -m "not integration"` passed (`33 passed, 1 deselected`)
- end-to-end:
  - reran dual-engine ingest with cached MinerU artifacts (`report_id=2`)
  - `net_increase_eq_sum_cashflows`: pass for
    - `2024-12-31` consolidated/parent
    - `2023-12-31` consolidated/parent
  - sample FX effects used in check:
    - consolidated `2024`: `-25855.07`
    - parent `2024`: `5914.21`
